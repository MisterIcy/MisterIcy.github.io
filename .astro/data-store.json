[["Map",1,2,9,10],"meta::meta",["Map",3,4,5,6,7,8],"astro-version","5.16.11","content-config-digest","1fc9591b21440065","astro-config-digest","{\"root\":{},\"srcDir\":{},\"publicDir\":{},\"outDir\":{},\"cacheDir\":{},\"site\":\"https://mistericy.github.io\",\"compressHTML\":true,\"base\":\"/\",\"trailingSlash\":\"ignore\",\"output\":\"static\",\"scopedStyleStrategy\":\"attribute\",\"build\":{\"format\":\"directory\",\"client\":{},\"server\":{},\"assets\":\"_astro\",\"serverEntry\":\"entry.mjs\",\"redirects\":true,\"inlineStylesheets\":\"auto\",\"concurrency\":1},\"server\":{\"open\":false,\"host\":false,\"port\":4321,\"streaming\":true,\"allowedHosts\":[]},\"redirects\":{},\"image\":{\"endpoint\":{\"route\":\"/_image\"},\"service\":{\"entrypoint\":\"astro/assets/services/sharp\",\"config\":{}},\"domains\":[],\"remotePatterns\":[],\"responsiveStyles\":false},\"devToolbar\":{\"enabled\":true},\"markdown\":{\"syntaxHighlight\":{\"type\":\"shiki\",\"excludeLangs\":[\"math\"]},\"shikiConfig\":{\"langs\":[],\"langAlias\":{},\"theme\":\"github-dark\",\"themes\":{},\"wrap\":false,\"transformers\":[]},\"remarkPlugins\":[],\"rehypePlugins\":[],\"remarkRehype\":{},\"gfm\":true,\"smartypants\":true},\"security\":{\"checkOrigin\":true,\"allowedDomains\":[]},\"env\":{\"schema\":{},\"validateSecrets\":false},\"experimental\":{\"clientPrerender\":false,\"contentIntellisense\":false,\"headingIdCompat\":false,\"preserveScriptOrder\":false,\"liveContentCollections\":false,\"csp\":false,\"staticImportMetaEnv\":false,\"chromeDevtoolsWorkspace\":false,\"failOnPrerenderConflict\":false,\"svgo\":false},\"legacy\":{\"collections\":false}}","blog",["Map",11,12,79,80],"extreme-debugging-in-php",{"id":11,"data":13,"body":42,"filePath":43,"assetImports":44,"digest":46,"rendered":47},{"title":14,"description":15,"pubDate":16,"updatedDate":17,"heroImage":18,"tags":19,"category":21,"excerpt":30,"keywords":31},"Extreme PHP Debugging: GDB & Docker Guide","Learn how to debug PHP crashes using custom debug binaries, Docker, and GDB. Master extreme PHP debugging techniques when standard tools fail.",["Date","2022-12-01T00:00:00.000Z"],["Date","2026-01-18T00:00:00.000Z"],"__ASTRO_IMAGE_../../assets/php-gdb.webp",[20,21,22,23,24,25,26,27,28,29],"PHP","Debugging","GDB","Docker","PHPUnit","xdebug","Software Engineering","Troubleshooting","PHP Development","Advanced Debugging","When PHPUnit crashes with exit code 143 and coverage generation fails silently, standard debugging tools won\\'t help. Learn how to build custom PHP debug binaries, use GDB to trace crashes, and debug deep PHP internals using Docker, custom builds, and advanced debugging techniques.\n",[32,33,34,35,36,37,38,39,40,41],"PHP debugging","GDB PHP","PHP debug binaries","Docker PHP debugging","PHPUnit debugging","PHP crash debugging","xdebug configuration","PHP custom build","PHP internals debugging","advanced PHP debugging","It was one of those awkward, lonely and quiet nights. I could not tell what [Spotify](https://open.spotify.com/track/0nMKVMCXCmRplsKKLt1TTh) was playing, nor what time it was. My eyes were fixed on my terminal's cursor. It was blinking, constantly blinking, like it was taunting me.\n\nSome of my PHPUnit tests were crashing unexpectedly while trying to generate code coverage. There was no exception, no error message, no stack traceâ€”nothing. The coverage report was never created and the PHP process was exiting silently with code `143`.\n\nWhat the actual ðŸ¤¬?\n\nThis is a story about **extreme PHP debugging**â€”when standard PHP debugging tools fail and you need to dive deep into PHP's internals using custom debug binaries, Docker containers, and the GNU Debugger (GDB) to track down crashes that occur at the C level.\n\nSo, first things first. How can you debug your tests, or even PHPUnit in such a case? The answer is easy. You donâ€™t because you canâ€™t. Such behavior alludes that something quite sinister lurks in your code. Something that crashes deep inside PHPâ€™s code. A statement, whose existence, creates a fatal error.\n\nBut we arenâ€™t here to talk about what you canâ€™t do. We are here to talk about what you can, actually, do.\n\n## Advanced PHP Debugging Techniques\n\nIâ€™ve lost count how many times I stumbled across a similar issue. Normally, I would totally ignore the issue. I would try my tests one by one in order to determine which one is the problematic. I would surrender, had I not been able to pinpoint the problematic piece of code. But I am not that person and I suspect that you arenâ€™t that person as well. Soâ€¦ Letâ€™s debug it.\n\nFor starters, you canâ€™t debug PHP with pre-compiled PHP binaries. You have to properly configure and compile your own binaries! And since weâ€™ll need a whole toolchain for this, letâ€™s Dockerize it.\n\n> Iâ€™m using Debian for this Docker image, but feel free to use the linux flavor you prefer.\n\n## ðŸ‘¶ Baby Steps\n\n```dockerfile\nFROM debian:bullseye-slim\nWORKDIR /php\n```\n\nWe, obviously, need to install the minimum set of dependencies to build PHP, so letâ€™s have a look at the [official repo](https://github.com/php/php-src#readme):\n\n```dockerfile\nRUN apt-get update && apt-get install -y pkg-config build-essential \\\n    autoconf bison re2c libxml2-dev libsqlite3-dev\n```\n\nWe need to fetch the source for the PHP version we want to build. Luckily, we will not have to `git clone` PHPâ€™s repo, since PHP offers source code [downloads](https://www.php.net/downloads.php) in their page. Weâ€™ll use PHP 7.4.33 and we need a way to download it into our image. Unfortunately `wget` is not installed in `bullseye-slim` so weâ€™ll have to `apt-get` it as well.\n\nSo, weâ€™ll go to the previous step where we are fetching PHPâ€™s dependencies and weâ€™ll add `wget` as well.\n\nAfter doing so, we are ready to download PHP:\n\n```dockerfile\nRUN wget -nv https://www.php.net/distributions/php-7.4.33.tar.gz && \\\n    tar xzf php-7.4.33.tar.gz\nWORKDIR /php/php-7.4.33\n```\n\nWe have downloaded, extracted and cdâ€™d into PHPâ€™s source! Now what? Weâ€™ll have to generate the configuration and configure the build prior to compiling:\n\n```dockerfile\nRUN ./buildconf -f\n```\n\nAt this point, we are ready to configure and compile PHP 7.4.33. However, this isnâ€™t a simple, copy snippet / paste snippet, case.\n\n1. You have to know how you want to configure your binaries.\n2. You have to know which PHP extensions your code requires.\n3. You have to know whether to enable or disable something.\n\nAnd this is a process of thinking, reading, trying and failing, until you succeed.\n\nSo, build your image, create a container and open a shell into it. Your working directory will be the one where PHPâ€™s sources lie. Type `./configure --help | more` and read through the extensive list of configuration options. A minimum debug build requires the flag `--enable-debug`.\n\nHowever, in my case, and most probably in yours as well, youâ€™ll need some other stuff too. Such as cURL, sockets or intl. And in order to set up these, youâ€™ll have some [fun](https://dwarffortresswiki.org/index.php/DF2014:Losing).\n\n## ðŸ› ï¸ Configuring and Building PHP\n\nMake a list of the extensions you need included and features you need enabled (or disabled). **DO NOT ADD THE CONFIGURE OPTIONS TO THE DOCKERFILE, YET.**\n\n> I repeat, DO NOT ADD THEM TO THE DOCKERFILE, YET!\n\nYou remember me telling you, to open a shell into the container you built? The reason you need it, is because you will have to **fetch the extensionsâ€™ dependencies**.\n\n> Didnâ€™t I tell you that this is going to be fun?\n\n```shell\n./configure --enable-fpm \\\n    --enable-debug \\\n    --with-openssl \\\n    --with-zlib \\\n    --with-curl \\\n    --enable-gd \\\n    --with-gettext \\\n    --enable-intl \\\n    --with-ldap \\\n    --with-mysqli \\\n    --enable-pcntl \\\n    --enable-sockets \\\n    --enable-sysvmsg \\\n    --with-xsl \\\n    --with-zip \\\n    --enable-mbstring \\\n    --with-pdo-mysql \\\n    --disable-short-tags\n```\n\nThe configure script is going to perform some checks and crash at some point or another, complaining about not being able to find some development dependencies. If it canâ€™t find `ldap` youâ€™ll probably have to `apt-get install libldap-dev`. If it canâ€™t find Oniguruma, youâ€™ll (not obviously, but probably) have to install `libonig-dev`. Rinse and repeat. Use common sense, apt-cache search and Google, in order to determine what you actually need.\n\nWhen you have gathered every package you have to install, youâ€™ll have to modify your Dockerfile so that they get fetched, before you even attempt to configure PHP.\n\nBefore venturing forth, run a `make clean && make -j${nproc} && make install`. Just in case. If everything went well, `php -v` should give you output, stating itâ€™s version and that it is a `NTS DEBUG` build.\n\n> #EverythingIsAwesome.\n\nAt this point, weâ€™ll also need xdebug. You know the drill. Grab its source in `tar.gz` format from xdebugâ€™s downloads page, bring it into the container and extract it is its own directory. `phpize`, `configure`, `make`.\n\nWhen everything is tested in the container you are working, you should move everything into your Dockerfile. It should look something like this:\n\n```dockerfile\nFROM debian:bullseye-slim\n\nRUN apt-get update && \\\n    apt-get upgrade && \\\n    apt-get install pkg-config build-essential autoconf bison re2c wget gdb \\\n    libxml2-dev libsqlite3-dev libonig-dev libz-dev \\\n    libssl-dev libcurl4-openssl-dev libzip-dev libpng-dev \\\n    libldap-dev libxslt-dev\n\nWORKDIR /php\n# Download PHP & xdebug\nRUN wget -nv https://www.php.net/distributions/php-7.4.33.tar.gz && \\\n    tar xzf php-7.4.33.tar.gz && \\\n    wget -nv https://xdebug.org/files/xdebug-3.1.6.tgz && \\\n    tar xzf xdebug-3.1.6.tgz\n\n# Build PHP\nWORKDIR /php/php-7.4.33\n\nRUN mkdir -p /usr/local/etc/php/conf.d/\n\nRUN ./buildconf -f && \\\n    ./configure --enable-fpm \\\n    --enable-debug \\\n    --with-openssl \\\n    --with-zlib \\\n    --with-curl \\\n    --enable-gd \\\n    --with-gettext \\\n    --enable-intl \\\n    --with-ldap \\\n    --with-mysqli \\\n    --enable-pcntl \\\n    --enable-sockets \\\n    --enable-sysvmsg \\\n    --with-xsl \\\n    --with-zip \\\n    --enable-mbstring \\\n    --with-pdo-mysql \\\n    --disable-short-tags \\\n    --with-config-file-scan-dir=/usr/local/etc/php/conf.d/ && \\\n    make clean && \\\n    make -j${nproc} && \\\n    make install\n\n# Build xdebug\nWORKDIR /php/xdebug-3.1.6\n\nRUN phpize && \\\n    ./configure --enable-xdebug && \\\n    make -j${nproc} && \\\n    make install\n\nRUN mkdir -p /var/www/html/\n\nWORKDIR /var/www/html\n```\n\n## Debugging PHP Crashes with GDB\n\nIf you are observant enough, youâ€™ll already have noticed that I added [`gdb`](https://en.wikipedia.org/wiki/GNU_Debugger) in the packages I am fetching into our image. Weâ€™ll need the GNU debugger in order to make PHP crash, then investigate why it crashed.\n\nBut before even attempting this, weâ€™ll have to properly configure PHP. php.ini and the likes.\n\nYouâ€™ll need, at least, to increase the `memory_limit`, to enable xdebug and to set `xdebug.mode` to `coverage`. If you are still reading me, youâ€™ll probably have guessed (correctly) that Iâ€™ll tell you to **R**ead **T**he **F**ine **M**anual, on how to do such things. Yes, I know that you can spam `-d` flags to PHP, however I highly suggest to craft a `php.ini` and an `xdebug.ini` (and each and every other .ini for each and every other extension you need configured).\n\nAnd (not only that, but mostly) that is the reason, you will definately need a `docker-compose.yaml`. Youâ€™ll have to mount your project at `/var/www/html` and youâ€™ll have to mount the directory containing your PHP configuration at `/usr/local/etc/php/conf.d/`\n\nIs your container ready yet?\n\nOpen a shell into itâ€¦\n\n\u003Chr/>\n\nI cannot say that I am a debugging expert, nor that I navigate through gdbâ€™s commands with ease. I usually work on a _need-to-know_ basis; Google is my best friend. So, unfortunately, this cannot be a gdb tutorial. But I can, at this point, give you some insight into whatâ€™s going on.\n\nAssuming that everything went fine, your cursor should be blinking and waiting to do thy bidding. Type `gdb php` in order to load PHP into the debugger and watch the cursor blink again. Weâ€™ll actually need to run something. In my case I have to `r ./vendor/bin/phpunit --coverage-clover=clover.xml`\n\n> # And it crashedâ€¦ ðŸ¤¬\n\nNow, weâ€™ll have to figure out why it crashes. Letâ€™s type `bt` in order to examine the [stack](https://en.wikipedia.org/wiki/Call_stack)â€¦ Get a [cheat sheet](https://gist.github.com/rkubik/b96c23bd8ed58333de37f2b8cd052c30#file-cheat_sheet-txt-L18) and happy hunting!\n\n\u003Chr/>\n\nIt took me hours to understand what the problem was. PHP was actually trying to perform an invalid operation. I not only had to examine the stack and functionsâ€™ parameters. I had PHPâ€™s source code, side by side with my debugger, trying to understand what each line was doing.\n\nEventually, after hours and hours of examing the values of structures and pointers, reading through C code and trying to follow the execution path, I pinpointed the source of all evil. It was a relatively safe `shell_exec`, hidden in a destructor. It seems that, somehow; donâ€™t ask, I never understood; PHP tried to execute this destructor and then all hell broke loose.\n\nMoral of the story? I should have listened to [Psalm](https://psalm.dev/), when it warned me that this piece of code was [forbidden](https://psalm.dev/docs/running_psalm/issues/ForbiddenCode/). But more importantly, when standard PHP debugging tools fail, you now know how to build custom PHP debug binaries, use GDB to trace crashes, and debug PHP internals at the C level.\n\n## Key Takeaways\n\n- **Custom PHP debug binaries** are essential for debugging crashes in PHP internals\n- **Docker** provides an isolated environment for building and debugging PHP from source\n- **GDB (GNU Debugger)** allows you to trace crashes and examine the call stack at the C level\n- **Xdebug** must be compiled from source when building custom PHP binaries\n- **Static analysis tools** like Psalm can help prevent these issues before they occur\n- When PHPUnit crashes silently, the problem often lies in PHP's C internals, not your PHP code\n\nThis extreme PHP debugging approach isn't for everyday issues, but when you're facing crashes that standard PHP debugging tools can't handle, building custom PHP debug binaries and using GDB is your path forward.","src/content/blog/extreme-debugging-in-php.md",[45],"../../assets/php-gdb.webp","76b23067762829b2",{"html":48,"metadata":49},"\u003Cp>It was one of those awkward, lonely and quiet nights. I could not tell what \u003Ca href=\"https://open.spotify.com/track/0nMKVMCXCmRplsKKLt1TTh\">Spotify\u003C/a> was playing, nor what time it was. My eyes were fixed on my terminalâ€™s cursor. It was blinking, constantly blinking, like it was taunting me.\u003C/p>\n\u003Cp>Some of my PHPUnit tests were crashing unexpectedly while trying to generate code coverage. There was no exception, no error message, no stack traceâ€”nothing. The coverage report was never created and the PHP process was exiting silently with code \u003Ccode>143\u003C/code>.\u003C/p>\n\u003Cp>What the actual ðŸ¤¬?\u003C/p>\n\u003Cp>This is a story about \u003Cstrong>extreme PHP debugging\u003C/strong>â€”when standard PHP debugging tools fail and you need to dive deep into PHPâ€™s internals using custom debug binaries, Docker containers, and the GNU Debugger (GDB) to track down crashes that occur at the C level.\u003C/p>\n\u003Cp>So, first things first. How can you debug your tests, or even PHPUnit in such a case? The answer is easy. You donâ€™t because you canâ€™t. Such behavior alludes that something quite sinister lurks in your code. Something that crashes deep inside PHPâ€™s code. A statement, whose existence, creates a fatal error.\u003C/p>\n\u003Cp>But we arenâ€™t here to talk about what you canâ€™t do. We are here to talk about what you can, actually, do.\u003C/p>\n\u003Ch2 id=\"advanced-php-debugging-techniques\">Advanced PHP Debugging Techniques\u003C/h2>\n\u003Cp>Iâ€™ve lost count how many times I stumbled across a similar issue. Normally, I would totally ignore the issue. I would try my tests one by one in order to determine which one is the problematic. I would surrender, had I not been able to pinpoint the problematic piece of code. But I am not that person and I suspect that you arenâ€™t that person as well. Soâ€¦ Letâ€™s debug it.\u003C/p>\n\u003Cp>For starters, you canâ€™t debug PHP with pre-compiled PHP binaries. You have to properly configure and compile your own binaries! And since weâ€™ll need a whole toolchain for this, letâ€™s Dockerize it.\u003C/p>\n\u003Cblockquote>\n\u003Cp>Iâ€™m using Debian for this Docker image, but feel free to use the linux flavor you prefer.\u003C/p>\n\u003C/blockquote>\n\u003Ch2 id=\"-baby-steps\">ðŸ‘¶ Baby Steps\u003C/h2>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"dockerfile\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">FROM\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> debian:bullseye-slim\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">WORKDIR\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> /php\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>We, obviously, need to install the minimum set of dependencies to build PHP, so letâ€™s have a look at the \u003Ca href=\"https://github.com/php/php-src#readme\">official repo\u003C/a>:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"dockerfile\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">RUN\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> apt-get update &#x26;&#x26; apt-get install -y pkg-config build-essential \\\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    autoconf bison re2c libxml2-dev libsqlite3-dev\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>We need to fetch the source for the PHP version we want to build. Luckily, we will not have to \u003Ccode>git clone\u003C/code> PHPâ€™s repo, since PHP offers source code \u003Ca href=\"https://www.php.net/downloads.php\">downloads\u003C/a> in their page. Weâ€™ll use PHP 7.4.33 and we need a way to download it into our image. Unfortunately \u003Ccode>wget\u003C/code> is not installed in \u003Ccode>bullseye-slim\u003C/code> so weâ€™ll have to \u003Ccode>apt-get\u003C/code> it as well.\u003C/p>\n\u003Cp>So, weâ€™ll go to the previous step where we are fetching PHPâ€™s dependencies and weâ€™ll add \u003Ccode>wget\u003C/code> as well.\u003C/p>\n\u003Cp>After doing so, we are ready to download PHP:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"dockerfile\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">RUN\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> wget -nv https://www.php.net/distributions/php-7.4.33.tar.gz &#x26;&#x26; \\\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    tar xzf php-7.4.33.tar.gz\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">WORKDIR\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> /php/php-7.4.33\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>We have downloaded, extracted and cdâ€™d into PHPâ€™s source! Now what? Weâ€™ll have to generate the configuration and configure the build prior to compiling:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"dockerfile\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">RUN\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> ./buildconf -f\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>At this point, we are ready to configure and compile PHP 7.4.33. However, this isnâ€™t a simple, copy snippet / paste snippet, case.\u003C/p>\n\u003Col>\n\u003Cli>You have to know how you want to configure your binaries.\u003C/li>\n\u003Cli>You have to know which PHP extensions your code requires.\u003C/li>\n\u003Cli>You have to know whether to enable or disable something.\u003C/li>\n\u003C/ol>\n\u003Cp>And this is a process of thinking, reading, trying and failing, until you succeed.\u003C/p>\n\u003Cp>So, build your image, create a container and open a shell into it. Your working directory will be the one where PHPâ€™s sources lie. Type \u003Ccode>./configure --help | more\u003C/code> and read through the extensive list of configuration options. A minimum debug build requires the flag \u003Ccode>--enable-debug\u003C/code>.\u003C/p>\n\u003Cp>However, in my case, and most probably in yours as well, youâ€™ll need some other stuff too. Such as cURL, sockets or intl. And in order to set up these, youâ€™ll have some \u003Ca href=\"https://dwarffortresswiki.org/index.php/DF2014:Losing\">fun\u003C/a>.\u003C/p>\n\u003Ch2 id=\"ï¸-configuring-and-building-php\">ðŸ› ï¸ Configuring and Building PHP\u003C/h2>\n\u003Cp>Make a list of the extensions you need included and features you need enabled (or disabled). \u003Cstrong>DO NOT ADD THE CONFIGURE OPTIONS TO THE DOCKERFILE, YET.\u003C/strong>\u003C/p>\n\u003Cblockquote>\n\u003Cp>I repeat, DO NOT ADD THEM TO THE DOCKERFILE, YET!\u003C/p>\n\u003C/blockquote>\n\u003Cp>You remember me telling you, to open a shell into the container you built? The reason you need it, is because you will have to \u003Cstrong>fetch the extensionsâ€™ dependencies\u003C/strong>.\u003C/p>\n\u003Cblockquote>\n\u003Cp>Didnâ€™t I tell you that this is going to be fun?\u003C/p>\n\u003C/blockquote>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"shell\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">./configure\u003C/span>\u003Cspan style=\"color:#79B8FF\"> --enable-fpm\u003C/span>\u003Cspan style=\"color:#79B8FF\"> \\\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">    --enable-debug\u003C/span>\u003Cspan style=\"color:#79B8FF\"> \\\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">    --with-openssl\u003C/span>\u003Cspan style=\"color:#79B8FF\"> \\\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">    --with-zlib\u003C/span>\u003Cspan style=\"color:#79B8FF\"> \\\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">    --with-curl\u003C/span>\u003Cspan style=\"color:#79B8FF\"> \\\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">    --enable-gd\u003C/span>\u003Cspan style=\"color:#79B8FF\"> \\\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">    --with-gettext\u003C/span>\u003Cspan style=\"color:#79B8FF\"> \\\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">    --enable-intl\u003C/span>\u003Cspan style=\"color:#79B8FF\"> \\\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">    --with-ldap\u003C/span>\u003Cspan style=\"color:#79B8FF\"> \\\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">    --with-mysqli\u003C/span>\u003Cspan style=\"color:#79B8FF\"> \\\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">    --enable-pcntl\u003C/span>\u003Cspan style=\"color:#79B8FF\"> \\\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">    --enable-sockets\u003C/span>\u003Cspan style=\"color:#79B8FF\"> \\\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">    --enable-sysvmsg\u003C/span>\u003Cspan style=\"color:#79B8FF\"> \\\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">    --with-xsl\u003C/span>\u003Cspan style=\"color:#79B8FF\"> \\\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">    --with-zip\u003C/span>\u003Cspan style=\"color:#79B8FF\"> \\\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">    --enable-mbstring\u003C/span>\u003Cspan style=\"color:#79B8FF\"> \\\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">    --with-pdo-mysql\u003C/span>\u003Cspan style=\"color:#79B8FF\"> \\\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">    --disable-short-tags\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The configure script is going to perform some checks and crash at some point or another, complaining about not being able to find some development dependencies. If it canâ€™t find \u003Ccode>ldap\u003C/code> youâ€™ll probably have to \u003Ccode>apt-get install libldap-dev\u003C/code>. If it canâ€™t find Oniguruma, youâ€™ll (not obviously, but probably) have to install \u003Ccode>libonig-dev\u003C/code>. Rinse and repeat. Use common sense, apt-cache search and Google, in order to determine what you actually need.\u003C/p>\n\u003Cp>When you have gathered every package you have to install, youâ€™ll have to modify your Dockerfile so that they get fetched, before you even attempt to configure PHP.\u003C/p>\n\u003Cp>Before venturing forth, run a \u003Ccode>make clean &#x26;&#x26; make -j${nproc} &#x26;&#x26; make install\u003C/code>. Just in case. If everything went well, \u003Ccode>php -v\u003C/code> should give you output, stating itâ€™s version and that it is a \u003Ccode>NTS DEBUG\u003C/code> build.\u003C/p>\n\u003Cblockquote>\n\u003Cp>#EverythingIsAwesome.\u003C/p>\n\u003C/blockquote>\n\u003Cp>At this point, weâ€™ll also need xdebug. You know the drill. Grab its source in \u003Ccode>tar.gz\u003C/code> format from xdebugâ€™s downloads page, bring it into the container and extract it is its own directory. \u003Ccode>phpize\u003C/code>, \u003Ccode>configure\u003C/code>, \u003Ccode>make\u003C/code>.\u003C/p>\n\u003Cp>When everything is tested in the container you are working, you should move everything into your Dockerfile. It should look something like this:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"dockerfile\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">FROM\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> debian:bullseye-slim\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">RUN\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> apt-get update &#x26;&#x26; \\\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    apt-get upgrade &#x26;&#x26; \\\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    apt-get install pkg-config build-essential autoconf bison re2c wget gdb \\\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    libxml2-dev libsqlite3-dev libonig-dev libz-dev \\\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    libssl-dev libcurl4-openssl-dev libzip-dev libpng-dev \\\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    libldap-dev libxslt-dev\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">WORKDIR\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> /php\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># Download PHP &#x26; xdebug\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">RUN\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> wget -nv https://www.php.net/distributions/php-7.4.33.tar.gz &#x26;&#x26; \\\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    tar xzf php-7.4.33.tar.gz &#x26;&#x26; \\\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    wget -nv https://xdebug.org/files/xdebug-3.1.6.tgz &#x26;&#x26; \\\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    tar xzf xdebug-3.1.6.tgz\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># Build PHP\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">WORKDIR\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> /php/php-7.4.33\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">RUN\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> mkdir -p /usr/local/etc/php/conf.d/\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">RUN\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> ./buildconf -f &#x26;&#x26; \\\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    ./configure --enable-fpm \\\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    --enable-debug \\\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    --with-openssl \\\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    --with-zlib \\\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    --with-curl \\\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    --enable-gd \\\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    --with-gettext \\\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    --enable-intl \\\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    --with-ldap \\\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    --with-mysqli \\\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    --enable-pcntl \\\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    --enable-sockets \\\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    --enable-sysvmsg \\\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    --with-xsl \\\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    --with-zip \\\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    --enable-mbstring \\\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    --with-pdo-mysql \\\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    --disable-short-tags \\\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    --with-config-file-scan-dir=/usr/local/etc/php/conf.d/ &#x26;&#x26; \\\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    make clean &#x26;&#x26; \\\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    make -j${nproc} &#x26;&#x26; \\\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    make install\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># Build xdebug\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">WORKDIR\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> /php/xdebug-3.1.6\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">RUN\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> phpize &#x26;&#x26; \\\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    ./configure --enable-xdebug &#x26;&#x26; \\\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    make -j${nproc} &#x26;&#x26; \\\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    make install\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">RUN\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> mkdir -p /var/www/html/\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">WORKDIR\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> /var/www/html\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch2 id=\"debugging-php-crashes-with-gdb\">Debugging PHP Crashes with GDB\u003C/h2>\n\u003Cp>If you are observant enough, youâ€™ll already have noticed that I added \u003Ca href=\"https://en.wikipedia.org/wiki/GNU_Debugger\">\u003Ccode>gdb\u003C/code>\u003C/a> in the packages I am fetching into our image. Weâ€™ll need the GNU debugger in order to make PHP crash, then investigate why it crashed.\u003C/p>\n\u003Cp>But before even attempting this, weâ€™ll have to properly configure PHP. php.ini and the likes.\u003C/p>\n\u003Cp>Youâ€™ll need, at least, to increase the \u003Ccode>memory_limit\u003C/code>, to enable xdebug and to set \u003Ccode>xdebug.mode\u003C/code> to \u003Ccode>coverage\u003C/code>. If you are still reading me, youâ€™ll probably have guessed (correctly) that Iâ€™ll tell you to \u003Cstrong>R\u003C/strong>ead \u003Cstrong>T\u003C/strong>he \u003Cstrong>F\u003C/strong>ine \u003Cstrong>M\u003C/strong>anual, on how to do such things. Yes, I know that you can spam \u003Ccode>-d\u003C/code> flags to PHP, however I highly suggest to craft a \u003Ccode>php.ini\u003C/code> and an \u003Ccode>xdebug.ini\u003C/code> (and each and every other .ini for each and every other extension you need configured).\u003C/p>\n\u003Cp>And (not only that, but mostly) that is the reason, you will definately need a \u003Ccode>docker-compose.yaml\u003C/code>. Youâ€™ll have to mount your project at \u003Ccode>/var/www/html\u003C/code> and youâ€™ll have to mount the directory containing your PHP configuration at \u003Ccode>/usr/local/etc/php/conf.d/\u003C/code>\u003C/p>\n\u003Cp>Is your container ready yet?\u003C/p>\n\u003Cp>Open a shell into itâ€¦\u003C/p>\n\u003Chr>\n\u003Cp>I cannot say that I am a debugging expert, nor that I navigate through gdbâ€™s commands with ease. I usually work on a \u003Cem>need-to-know\u003C/em> basis; Google is my best friend. So, unfortunately, this cannot be a gdb tutorial. But I can, at this point, give you some insight into whatâ€™s going on.\u003C/p>\n\u003Cp>Assuming that everything went fine, your cursor should be blinking and waiting to do thy bidding. Type \u003Ccode>gdb php\u003C/code> in order to load PHP into the debugger and watch the cursor blink again. Weâ€™ll actually need to run something. In my case I have to \u003Ccode>r ./vendor/bin/phpunit --coverage-clover=clover.xml\u003C/code>\u003C/p>\n\u003Cblockquote>\n\u003Ch1 id=\"and-it-crashed\">And it crashedâ€¦ ðŸ¤¬\u003C/h1>\n\u003C/blockquote>\n\u003Cp>Now, weâ€™ll have to figure out why it crashes. Letâ€™s type \u003Ccode>bt\u003C/code> in order to examine the \u003Ca href=\"https://en.wikipedia.org/wiki/Call_stack\">stack\u003C/a>â€¦ Get a \u003Ca href=\"https://gist.github.com/rkubik/b96c23bd8ed58333de37f2b8cd052c30#file-cheat_sheet-txt-L18\">cheat sheet\u003C/a> and happy hunting!\u003C/p>\n\u003Chr>\n\u003Cp>It took me hours to understand what the problem was. PHP was actually trying to perform an invalid operation. I not only had to examine the stack and functionsâ€™ parameters. I had PHPâ€™s source code, side by side with my debugger, trying to understand what each line was doing.\u003C/p>\n\u003Cp>Eventually, after hours and hours of examing the values of structures and pointers, reading through C code and trying to follow the execution path, I pinpointed the source of all evil. It was a relatively safe \u003Ccode>shell_exec\u003C/code>, hidden in a destructor. It seems that, somehow; donâ€™t ask, I never understood; PHP tried to execute this destructor and then all hell broke loose.\u003C/p>\n\u003Cp>Moral of the story? I should have listened to \u003Ca href=\"https://psalm.dev/\">Psalm\u003C/a>, when it warned me that this piece of code was \u003Ca href=\"https://psalm.dev/docs/running_psalm/issues/ForbiddenCode/\">forbidden\u003C/a>. But more importantly, when standard PHP debugging tools fail, you now know how to build custom PHP debug binaries, use GDB to trace crashes, and debug PHP internals at the C level.\u003C/p>\n\u003Ch2 id=\"key-takeaways\">Key Takeaways\u003C/h2>\n\u003Cul>\n\u003Cli>\u003Cstrong>Custom PHP debug binaries\u003C/strong> are essential for debugging crashes in PHP internals\u003C/li>\n\u003Cli>\u003Cstrong>Docker\u003C/strong> provides an isolated environment for building and debugging PHP from source\u003C/li>\n\u003Cli>\u003Cstrong>GDB (GNU Debugger)\u003C/strong> allows you to trace crashes and examine the call stack at the C level\u003C/li>\n\u003Cli>\u003Cstrong>Xdebug\u003C/strong> must be compiled from source when building custom PHP binaries\u003C/li>\n\u003Cli>\u003Cstrong>Static analysis tools\u003C/strong> like Psalm can help prevent these issues before they occur\u003C/li>\n\u003Cli>When PHPUnit crashes silently, the problem often lies in PHPâ€™s C internals, not your PHP code\u003C/li>\n\u003C/ul>\n\u003Cp>This extreme PHP debugging approach isnâ€™t for everyday issues, but when youâ€™re facing crashes that standard PHP debugging tools canâ€™t handle, building custom PHP debug binaries and using GDB is your path forward.\u003C/p>",{"headings":50,"localImagePaths":71,"remoteImagePaths":72,"frontmatter":73,"imagePaths":78},[51,55,58,61,64,68],{"depth":52,"slug":53,"text":54},2,"advanced-php-debugging-techniques","Advanced PHP Debugging Techniques",{"depth":52,"slug":56,"text":57},"-baby-steps","ðŸ‘¶ Baby Steps",{"depth":52,"slug":59,"text":60},"ï¸-configuring-and-building-php","ðŸ› ï¸ Configuring and Building PHP",{"depth":52,"slug":62,"text":63},"debugging-php-crashes-with-gdb","Debugging PHP Crashes with GDB",{"depth":65,"slug":66,"text":67},1,"and-it-crashed","And it crashedâ€¦ ðŸ¤¬",{"depth":52,"slug":69,"text":70},"key-takeaways","Key Takeaways",[],[],{"title":14,"description":15,"pubDate":74,"updatedDate":75,"heroImage":45,"category":21,"tags":76,"excerpt":30,"keywords":77},"2022-12-01","2026-01-18",[20,21,22,23,24,25,26,27,28,29],[32,33,34,35,36,37,38,39,40,41],[],"reverse-engineering-hexplore-1",{"id":79,"data":81,"body":111,"filePath":112,"assetImports":113,"digest":116,"rendered":117},{"title":82,"description":83,"pubDate":84,"heroImage":85,"tags":86,"category":87,"excerpt":97,"keywords":98},"Reverse Engineering Hexplore: My Journey Begins","Learn reverse engineering techniques by exploring Hexplore, a 1990s game. Master x86 assembly, Ghidra decompilation, Win32 APIs, and game data formats to resurrect classic software.",["Date","2024-09-20T00:00:00.000Z"],"__ASTRO_IMAGE_../../assets/hexplore-1.webp",[87,88,89,90,91,92,93,94,95,96],"Reverse Engineering","Hexplore","x86 Assembly","Game Reverse Engineering","Ghidra","Win32 API","DirectX","Software Archaeology","Binary Analysis","Game Hacking","Join the reverse engineering journey of Hexplore â€” exploring x86 assembly, Ghidra, Win32 APIs, and game data formats to resurrect a 1990s classic. Learn how to dig into old binaries and rebuild lost code.",[99,100,101,102,103,104,105,106,107,108,109,110],"reverse engineering Hexplore","x86 assembly reverse engineering","Ghidra tutorial","game reverse engineering","Win32 API reverse engineering","DirectX reverse engineering","software archaeology","binary analysis","game hacking","decompilation techniques","1990s game reverse engineering","Hexplore game analysis","Recently, I came across a game that's nearly a quarter of a century old: [Hexplore](https://www.gog.com/en/game/hexplore). It's an Action / Adventure game with RPG elements and the GOG description reads:\n\n> Immerse yourself in a medieval world. A world where Garkham, Grand Master of the Black Magicians, has sworn to take possession of the Book of Hexplore. From this moment, the whole world is in great peril. For this manuscript will most certainly lead those who find it to the Garden of Eden, resting place of the Divine Power.\n\n![Hexplore Screenshot](../../assets/hexplore.webp)\n\nBack in those days, I was the proud owner of an AMD K6 with a super-noisy 2GB hard drive, 32MB of RAM, and a VGA card capable of displaying 256 colors at 640x480 resolution on a 14-inch CRT monitor. Now _thatâ€™s_ what I call a gaming setup!\n\nNostalgia aside, itâ€™s a game I spent countless hours playing, fighting monsters and solving riddles and puzzles. It was nowhere near Diablo, either in terms of hack-and-slash combat or RPG elements, but it had its moments. Over the years, Iâ€™ve revisited it occasionally &mdash; not just for nostalgia, but for its unique design and gameplay.\n\nUnfortunately, even with its GOG re-release, the game feels nearly unplayable on modern systems. It was designed for 640x480 resolution with 256 colors, and as you can imagine, running that on a 32-inch 4K monitor is far from ideal.\n\nSo, I thought:\n\n> _Can I do something about it?_\n\nBeing me, with my crazy ideas about impossible things, I figured I _might_ be able to make the game playable again. Unfortunately, this is a long and difficult project that could take years, and the most likely outcome is that it may never be finished. But Iâ€™ve started. And this is my journal of reverse engineering a 90s game.\n\n## First things first: Baby Steps\n\nItâ€™s been a very long time since I last touched C++ or read x86 Assembly. To tackle a project like this, you not only need a copy of [Ghidra](https://ghidra-sre.org/), but you also need to know a thing or two about how those ~~magnificent~~ hellish machines, operating systems, and APIs work. Being a firm believer in RTFM[^1], I knew I had to start by getting my hands on some good documentation.\n\n> Enter the world of software archaeology\n\nHexplore was released in August 1998, the same year as Windows 98. Given that the company that developed the game was formed around [1996](https://rpgwatch.com/developers/heliovisions-productions-1069.html) and that the typical development cycle for a game was around one year[^2], I estimate that it took about 12 to 18 months to develop. So, we can safely say that development likely began in late 1996 or early 1997.\n\nAssuming they used whatever cutting-edge technology was available at the time, we can make the following guesses:\n\n1. There was no [MMX](https://en.wikipedia.org/wiki/MMX_(instruction_set)) or [3DNow!](https://en.wikipedia.org/wiki/3DNow!); the world ran on the good old x86-32 instruction set.\n2. Development was likely done on Windows 95/NT4, as both were released in 1995.\n3. The code was probably written in Visual C++ 4.0, which was released in late 1995.\n4. The game probably uses Microsoft's DirectX 5.0.\n\nFor the time being, we need the following resources:\n\n- [x86 Instruction Set](https://www.felixcloutier.com/x86/) (_I donâ€™t suggest Intelâ€™s or AMDâ€™s PDFs, as they are ginormous._)\n- [Win32 API](https://learn.microsoft.com/en-us/windows/win32/api/)\n- [DirectX 5 Documentation](https://library.thedatadungeon.com/directx5/)\n\nAlso, I should get a [book](https://www.amazon.com/x64-Assembly-Language-Step-Step-dp-1394155247/dp/1394155247) or [two](https://www.amazon.com/Learn-Program-Assembly-Foundational-Programmers/dp/1484274369/) on x86 Assembly. Besides the instruction set, I need to understand how things work in order to reverse-engineer and rewrite them effectively.\n\nAnd thus, armed with the forbidden manuscripts, patience, and a cup of coffee, I'll delve into the ancient art of reverse engineering. For it is not enough to merely read the cryptic runes of `REPNE SCASB ES:EDI` from dusty tomes of knowledge; no, I must grasp their very essence, to unweave the fabric of the machine and forge it anew in a higher tongue. Only then can I hope to resurrect the relics of the past, breathing life into the forgotten code once more.\n\n## The lair of Ghidra\n\nFor the record, let me state that I am not a beginner in either reverse engineering or assembly. I had a pretty solid knowledge of how _stuff_ works. And Iâ€™m using the past tense because I havenâ€™t touched either assembly or reverse engineering in a very long time. Yet, I still remember a trick or two.\n\nGhidra, besides being a [disassembler](https://en.wikipedia.org/wiki/Disassembler), is also a [decompiler](https://en.wikipedia.org/wiki/Decompiler). It can not only translate machine code into Assembly, but it can also (try to) reconstruct a C representation of the program we are working on. This is both a curse and a blessing.\n\n### Blessings\n\nItâ€™s a blessing for those of us who can use our heads as a C interpreter &mdash; _shift by eight bits and **and** it with `0xff`_ &mdash; however, the following simple snippet requires a translator for those who are not accustomed to reading assembly:\n\n```assembly\nMOV ECX, 0x08\nSHR EAX, ECX\nMOV ECX, 0xff\nAND EAX, ECX\n```\n\n### ...and curses\n\nAnd itâ€™s a curse, a terrible curse that can sometimes frustrate you so much that youâ€™ll want to punch your shiny, curved screen right in the middle. I wonâ€™t tell you the reason before giving you a real-life example that Iâ€™ve come across countless times:\n\n```assembly\nMOV EDI, dword ptr [PTR_DAT_00590108]\nOR ECX, 0xffffffff\nXOR EAX, EAX\nMOV dword ptr [ESP + local_248], EDI\nREPNE SCASB ES:EDI\nNOT ECX\nDEC ECX\nMOV EBP, ECX\n```\n\nLet's see, what does this do?\n\nThe first four instructions are not a big deal; we load the value of a pointer into the `EDI` register, we\nset the `ECX` register to `0xffffffff`, we clear the `EAX` register and we move the value of `EDI` into our stack, on the position specifed by `ESP + local_248`. However, the fifth instruction is pretty interesting. It [scans](https://www.felixcloutier.com/x86/scas:scasb:scasw:scasd) a byte in `EDI` and compares it with the value stored in `AL`. It [repeats](https://www.felixcloutier.com/x86/rep:repe:repz:repne:repnz) that scanning until either the zero flag (`ZF`) is set or `ECX` is 0.\nDoes it start making sense?\n\nAfter scanning the string, it `NOT`s the `ECX` register and decrements it by one, effectively giving us the number of bytes the string contains, or simply `strlen`.\n\nBut why, Ghidra, doesnâ€™t it simply translate this to `strlen` and instead translates it to (more or less) the following gibberish?\n\n```c\nuVar1 = 0xffffffff;\nlocal_248 = (WCHAR *)PTR_DAT_00590108;\npcVar10 = PTR_DAT_00590108;\ndo {\n    if (uVar1 == 0) break;\n    uVar1 = uVar1 - 1;\n    cVar7 = *pcVar10;\n    pcVar10 = pcVar10 + 1;\n} while (cVar7 != '\\0');\npCVar9 = (LPSTR)(~uVar1 - 1);\n```\n\nItâ€™s quite possible that the compiler performs aggressive optimization by inlining the `strlen` function (i.e., replacing the function call with the body of the function), which effectively eliminates the overhead of calling the function. Alternatively, it could be due to decompilation limitations, which may not map the assembly code directly to a function call. Whatever the case, we know that we cannot truly rely on the decompiler and definitely need to understand assembly.\n\nThat's where a reference to assembly instructions comes in handy &mdash; and more than that, it is the go-to resource when something doesnâ€™t make any sense.\n\n## Verifying our claims\n\nAfter loading and analyzing the executable, we can see that Ghidra has identified a couple of VC++ library functions, such as `_strlen`, `_memcmp`, and `_rand`. This strongly indicates that the game was written in C/C++ and compiled with Microsoft's compiler. The exact version is not known, but it is likely one of Visual C++ 4.0, 5.0, or 6.0. And since the world hadn't yet discovered the marvels of [SIMD](https://en.wikipedia.org/wiki/Single_instruction,_multiple_data), weâ€™ll be working with fewer instructions, fewer registers, and less complex stuff. _Everything is awesome!_\n\nBy navigating Ghidra's **Symbol Table**, we can see calls to `DirectDrawCreate` (that's DirectX's DirectDraw ðŸ˜‰), `DirectSoundCreate` (ðŸŽ§), `_SmackOpen` (that's [Smacker Video](https://en.wikipedia.org/wiki/Smacker_video) ðŸŽ¥), and various other Win32 API calls. Hexplore also uses [SecuROM](https://en.wikipedia.org/wiki/SecuROM), and I'm sure I'll find some code related to it as well.\n\nWith our resources ready to be consumed, the executable disassembled, and a fresh cup of coffee, we are ready to get into some serious software archaeology and reverse engineering. But before diving deep into the obscure world of x86, let's cover a few final things &mdash; which, I believe, I should have stated earlier in this post.\n\n## What now?\n\nAs you have undoubtedly guessed, this is the first part in a series of posts focused on both reverse engineering and the methods used to understand and re-implement something, as well as on the specific game &mdash; which I enjoyed playing both as a kid and as an adult. The posts will follow a _diary format_. I do not intend to write a book on RE, nor tutorials on the subject. I merely want to document a long journey Iâ€™ve decided to embark upon in order to expand my knowledge, have some fun tinkering with an old game, and, why not, produce something useful &mdash; either for myself or for others.\n\nThis journey had some milestones set from its inception stage &mdash;that is, when I first thought, _why not reverse engineer Hexplore?_. The first milestone has been reached: researching the resources Iâ€™ll need to start working on it. I might not know everything, and I am sure weird things will come up along the way, but I have a solid stash of information I can use to understand and re-implement the things I want to. Hexplore uses a [voxel](https://en.wikipedia.org/wiki/Voxel) engine, which (most probably, needs to be verified) was implemented in software. Considering the limitations of the software and hardware that existed back then, everything was new: 32-bit Windows, DirectX, hardware accelerators (nVidiaâ€™s Riva, 3dfxâ€™s Voodoo, and ATIâ€™s RAGE are some examples) were just becoming affordable for home computersâ€”you name it. _Could I re-implement this voxel engine in a modern API, say, Vulkan?_\n\nI honestly don't know. Thus, Iâ€™ve set the project's milestones and will try to reach them:\n\n- [X] Investigate the game and gather necessary resources for reverse engineering\n- [ ] Reverse engineer the game's data file formats and produce documentation for them\n- [ ] Craft tools for viewing (and possibly manipulating) the game's assets\n- [ ] Imagine something bigger.\n\nUnderstanding the game's data file formats, although it sounds simple, will be both a difficult and time-consuming task &mdash; as such, it must not be underestimated. I've already started looking into the files that hold the game's texts (i.e., the `st1` files) and made some progress, but that's a story for another post.\n\n## Closing words\n\nThe next time we meet, I'll be making a deep dive into the game's data file formats. Expect some frustration, as the developers have taken some clever measures against people like me (which is not unheard of). We'll also get our hands dirty with some C++, talk about developer decisions, and continue our journey into the abyss. And as those who have played Hexplore vividly remember:\n\n> You must gather your party before venturing forth.\n\n[^1]: Read(ing) the fucking manual.\n[^2]: id Software began working on Doom [after the release of Spear of Destiny](https://5years.doomworld.com/interviews/johnromero/), and the game was released on [December 10, 1993](https://en.wikipedia.org/wiki/Doom_(1993_video_game)).","src/content/blog/reverse-engineering-hexplore-1.md",[114,115],"../../assets/hexplore.webp","../../assets/hexplore-1.webp","ed452ad1f8075100",{"html":118,"metadata":119},"\u003Cp>Recently, I came across a game thatâ€™s nearly a quarter of a century old: \u003Ca href=\"https://www.gog.com/en/game/hexplore\">Hexplore\u003C/a>. Itâ€™s an Action / Adventure game with RPG elements and the GOG description reads:\u003C/p>\n\u003Cblockquote>\n\u003Cp>Immerse yourself in a medieval world. A world where Garkham, Grand Master of the Black Magicians, has sworn to take possession of the Book of Hexplore. From this moment, the whole world is in great peril. For this manuscript will most certainly lead those who find it to the Garden of Eden, resting place of the Divine Power.\u003C/p>\n\u003C/blockquote>\n\u003Cp>\u003Cimg __ASTRO_IMAGE_=\"{&#x22;src&#x22;:&#x22;../../assets/hexplore.webp&#x22;,&#x22;alt&#x22;:&#x22;Hexplore Screenshot&#x22;,&#x22;index&#x22;:0}\">\u003C/p>\n\u003Cp>Back in those days, I was the proud owner of an AMD K6 with a super-noisy 2GB hard drive, 32MB of RAM, and a VGA card capable of displaying 256 colors at 640x480 resolution on a 14-inch CRT monitor. Now \u003Cem>thatâ€™s\u003C/em> what I call a gaming setup!\u003C/p>\n\u003Cp>Nostalgia aside, itâ€™s a game I spent countless hours playing, fighting monsters and solving riddles and puzzles. It was nowhere near Diablo, either in terms of hack-and-slash combat or RPG elements, but it had its moments. Over the years, Iâ€™ve revisited it occasionally â€” not just for nostalgia, but for its unique design and gameplay.\u003C/p>\n\u003Cp>Unfortunately, even with its GOG re-release, the game feels nearly unplayable on modern systems. It was designed for 640x480 resolution with 256 colors, and as you can imagine, running that on a 32-inch 4K monitor is far from ideal.\u003C/p>\n\u003Cp>So, I thought:\u003C/p>\n\u003Cblockquote>\n\u003Cp>\u003Cem>Can I do something about it?\u003C/em>\u003C/p>\n\u003C/blockquote>\n\u003Cp>Being me, with my crazy ideas about impossible things, I figured I \u003Cem>might\u003C/em> be able to make the game playable again. Unfortunately, this is a long and difficult project that could take years, and the most likely outcome is that it may never be finished. But Iâ€™ve started. And this is my journal of reverse engineering a 90s game.\u003C/p>\n\u003Ch2 id=\"first-things-first-baby-steps\">First things first: Baby Steps\u003C/h2>\n\u003Cp>Itâ€™s been a very long time since I last touched C++ or read x86 Assembly. To tackle a project like this, you not only need a copy of \u003Ca href=\"https://ghidra-sre.org/\">Ghidra\u003C/a>, but you also need to know a thing or two about how those \u003Cdel>magnificent\u003C/del> hellish machines, operating systems, and APIs work. Being a firm believer in RTFM\u003Csup>\u003Ca href=\"#user-content-fn-1\" id=\"user-content-fnref-1\" data-footnote-ref=\"\" aria-describedby=\"footnote-label\">1\u003C/a>\u003C/sup>, I knew I had to start by getting my hands on some good documentation.\u003C/p>\n\u003Cblockquote>\n\u003Cp>Enter the world of software archaeology\u003C/p>\n\u003C/blockquote>\n\u003Cp>Hexplore was released in August 1998, the same year as Windows 98. Given that the company that developed the game was formed around \u003Ca href=\"https://rpgwatch.com/developers/heliovisions-productions-1069.html\">1996\u003C/a> and that the typical development cycle for a game was around one year\u003Csup>\u003Ca href=\"#user-content-fn-2\" id=\"user-content-fnref-2\" data-footnote-ref=\"\" aria-describedby=\"footnote-label\">2\u003C/a>\u003C/sup>, I estimate that it took about 12 to 18 months to develop. So, we can safely say that development likely began in late 1996 or early 1997.\u003C/p>\n\u003Cp>Assuming they used whatever cutting-edge technology was available at the time, we can make the following guesses:\u003C/p>\n\u003Col>\n\u003Cli>There was no \u003Ca href=\"https://en.wikipedia.org/wiki/MMX_(instruction_set)\">MMX\u003C/a> or \u003Ca href=\"https://en.wikipedia.org/wiki/3DNow!\">3DNow!\u003C/a>; the world ran on the good old x86-32 instruction set.\u003C/li>\n\u003Cli>Development was likely done on Windows 95/NT4, as both were released in 1995.\u003C/li>\n\u003Cli>The code was probably written in Visual C++ 4.0, which was released in late 1995.\u003C/li>\n\u003Cli>The game probably uses Microsoftâ€™s DirectX 5.0.\u003C/li>\n\u003C/ol>\n\u003Cp>For the time being, we need the following resources:\u003C/p>\n\u003Cul>\n\u003Cli>\u003Ca href=\"https://www.felixcloutier.com/x86/\">x86 Instruction Set\u003C/a> (\u003Cem>I donâ€™t suggest Intelâ€™s or AMDâ€™s PDFs, as they are ginormous.\u003C/em>)\u003C/li>\n\u003Cli>\u003Ca href=\"https://learn.microsoft.com/en-us/windows/win32/api/\">Win32 API\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"https://library.thedatadungeon.com/directx5/\">DirectX 5 Documentation\u003C/a>\u003C/li>\n\u003C/ul>\n\u003Cp>Also, I should get a \u003Ca href=\"https://www.amazon.com/x64-Assembly-Language-Step-Step-dp-1394155247/dp/1394155247\">book\u003C/a> or \u003Ca href=\"https://www.amazon.com/Learn-Program-Assembly-Foundational-Programmers/dp/1484274369/\">two\u003C/a> on x86 Assembly. Besides the instruction set, I need to understand how things work in order to reverse-engineer and rewrite them effectively.\u003C/p>\n\u003Cp>And thus, armed with the forbidden manuscripts, patience, and a cup of coffee, Iâ€™ll delve into the ancient art of reverse engineering. For it is not enough to merely read the cryptic runes of \u003Ccode>REPNE SCASB ES:EDI\u003C/code> from dusty tomes of knowledge; no, I must grasp their very essence, to unweave the fabric of the machine and forge it anew in a higher tongue. Only then can I hope to resurrect the relics of the past, breathing life into the forgotten code once more.\u003C/p>\n\u003Ch2 id=\"the-lair-of-ghidra\">The lair of Ghidra\u003C/h2>\n\u003Cp>For the record, let me state that I am not a beginner in either reverse engineering or assembly. I had a pretty solid knowledge of how \u003Cem>stuff\u003C/em> works. And Iâ€™m using the past tense because I havenâ€™t touched either assembly or reverse engineering in a very long time. Yet, I still remember a trick or two.\u003C/p>\n\u003Cp>Ghidra, besides being a \u003Ca href=\"https://en.wikipedia.org/wiki/Disassembler\">disassembler\u003C/a>, is also a \u003Ca href=\"https://en.wikipedia.org/wiki/Decompiler\">decompiler\u003C/a>. It can not only translate machine code into Assembly, but it can also (try to) reconstruct a C representation of the program we are working on. This is both a curse and a blessing.\u003C/p>\n\u003Ch3 id=\"blessings\">Blessings\u003C/h3>\n\u003Cp>Itâ€™s a blessing for those of us who can use our heads as a C interpreter â€” \u003Cem>shift by eight bits and \u003Cstrong>and\u003C/strong> it with \u003Ccode>0xff\u003C/code>\u003C/em> â€” however, the following simple snippet requires a translator for those who are not accustomed to reading assembly:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>MOV ECX, 0x08\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>SHR EAX, ECX\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>MOV ECX, 0xff\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>AND EAX, ECX\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"and-curses\">â€¦and curses\u003C/h3>\n\u003Cp>And itâ€™s a curse, a terrible curse that can sometimes frustrate you so much that youâ€™ll want to punch your shiny, curved screen right in the middle. I wonâ€™t tell you the reason before giving you a real-life example that Iâ€™ve come across countless times:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>MOV EDI, dword ptr [PTR_DAT_00590108]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>OR ECX, 0xffffffff\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>XOR EAX, EAX\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>MOV dword ptr [ESP + local_248], EDI\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>REPNE SCASB ES:EDI\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>NOT ECX\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>DEC ECX\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>MOV EBP, ECX\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Letâ€™s see, what does this do?\u003C/p>\n\u003Cp>The first four instructions are not a big deal; we load the value of a pointer into the \u003Ccode>EDI\u003C/code> register, we\nset the \u003Ccode>ECX\u003C/code> register to \u003Ccode>0xffffffff\u003C/code>, we clear the \u003Ccode>EAX\u003C/code> register and we move the value of \u003Ccode>EDI\u003C/code> into our stack, on the position specifed by \u003Ccode>ESP + local_248\u003C/code>. However, the fifth instruction is pretty interesting. It \u003Ca href=\"https://www.felixcloutier.com/x86/scas:scasb:scasw:scasd\">scans\u003C/a> a byte in \u003Ccode>EDI\u003C/code> and compares it with the value stored in \u003Ccode>AL\u003C/code>. It \u003Ca href=\"https://www.felixcloutier.com/x86/rep:repe:repz:repne:repnz\">repeats\u003C/a> that scanning until either the zero flag (\u003Ccode>ZF\u003C/code>) is set or \u003Ccode>ECX\u003C/code> is 0.\nDoes it start making sense?\u003C/p>\n\u003Cp>After scanning the string, it \u003Ccode>NOT\u003C/code>s the \u003Ccode>ECX\u003C/code> register and decrements it by one, effectively giving us the number of bytes the string contains, or simply \u003Ccode>strlen\u003C/code>.\u003C/p>\n\u003Cp>But why, Ghidra, doesnâ€™t it simply translate this to \u003Ccode>strlen\u003C/code> and instead translates it to (more or less) the following gibberish?\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">uVar1 \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#F97583\"> 0x\u003C/span>\u003Cspan style=\"color:#79B8FF\">ffffffff\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">local_248 \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (WCHAR \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)PTR_DAT_00590108;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">pcVar10 \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> PTR_DAT_00590108;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">do\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (uVar1 \u003C/span>\u003Cspan style=\"color:#F97583\">==\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) \u003C/span>\u003Cspan style=\"color:#F97583\">break\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    uVar1 \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> uVar1 \u003C/span>\u003Cspan style=\"color:#F97583\">-\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    cVar7 \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#F97583\"> *\u003C/span>\u003Cspan style=\"color:#E1E4E8\">pcVar10;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    pcVar10 \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> pcVar10 \u003C/span>\u003Cspan style=\"color:#F97583\">+\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">} \u003C/span>\u003Cspan style=\"color:#F97583\">while\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (cVar7 \u003C/span>\u003Cspan style=\"color:#F97583\">!=\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> '\u003C/span>\u003Cspan style=\"color:#79B8FF\">\\0\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">pCVar9 \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (LPSTR)(\u003C/span>\u003Cspan style=\"color:#F97583\">~\u003C/span>\u003Cspan style=\"color:#E1E4E8\">uVar1 \u003C/span>\u003Cspan style=\"color:#F97583\">-\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">);\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Itâ€™s quite possible that the compiler performs aggressive optimization by inlining the \u003Ccode>strlen\u003C/code> function (i.e., replacing the function call with the body of the function), which effectively eliminates the overhead of calling the function. Alternatively, it could be due to decompilation limitations, which may not map the assembly code directly to a function call. Whatever the case, we know that we cannot truly rely on the decompiler and definitely need to understand assembly.\u003C/p>\n\u003Cp>Thatâ€™s where a reference to assembly instructions comes in handy â€” and more than that, it is the go-to resource when something doesnâ€™t make any sense.\u003C/p>\n\u003Ch2 id=\"verifying-our-claims\">Verifying our claims\u003C/h2>\n\u003Cp>After loading and analyzing the executable, we can see that Ghidra has identified a couple of VC++ library functions, such as \u003Ccode>_strlen\u003C/code>, \u003Ccode>_memcmp\u003C/code>, and \u003Ccode>_rand\u003C/code>. This strongly indicates that the game was written in C/C++ and compiled with Microsoftâ€™s compiler. The exact version is not known, but it is likely one of Visual C++ 4.0, 5.0, or 6.0. And since the world hadnâ€™t yet discovered the marvels of \u003Ca href=\"https://en.wikipedia.org/wiki/Single_instruction,_multiple_data\">SIMD\u003C/a>, weâ€™ll be working with fewer instructions, fewer registers, and less complex stuff. \u003Cem>Everything is awesome!\u003C/em>\u003C/p>\n\u003Cp>By navigating Ghidraâ€™s \u003Cstrong>Symbol Table\u003C/strong>, we can see calls to \u003Ccode>DirectDrawCreate\u003C/code> (thatâ€™s DirectXâ€™s DirectDraw ðŸ˜‰), \u003Ccode>DirectSoundCreate\u003C/code> (ðŸŽ§), \u003Ccode>_SmackOpen\u003C/code> (thatâ€™s \u003Ca href=\"https://en.wikipedia.org/wiki/Smacker_video\">Smacker Video\u003C/a> ðŸŽ¥), and various other Win32 API calls. Hexplore also uses \u003Ca href=\"https://en.wikipedia.org/wiki/SecuROM\">SecuROM\u003C/a>, and Iâ€™m sure Iâ€™ll find some code related to it as well.\u003C/p>\n\u003Cp>With our resources ready to be consumed, the executable disassembled, and a fresh cup of coffee, we are ready to get into some serious software archaeology and reverse engineering. But before diving deep into the obscure world of x86, letâ€™s cover a few final things â€” which, I believe, I should have stated earlier in this post.\u003C/p>\n\u003Ch2 id=\"what-now\">What now?\u003C/h2>\n\u003Cp>As you have undoubtedly guessed, this is the first part in a series of posts focused on both reverse engineering and the methods used to understand and re-implement something, as well as on the specific game â€” which I enjoyed playing both as a kid and as an adult. The posts will follow a \u003Cem>diary format\u003C/em>. I do not intend to write a book on RE, nor tutorials on the subject. I merely want to document a long journey Iâ€™ve decided to embark upon in order to expand my knowledge, have some fun tinkering with an old game, and, why not, produce something useful â€” either for myself or for others.\u003C/p>\n\u003Cp>This journey had some milestones set from its inception stage â€”that is, when I first thought, \u003Cem>why not reverse engineer Hexplore?\u003C/em>. The first milestone has been reached: researching the resources Iâ€™ll need to start working on it. I might not know everything, and I am sure weird things will come up along the way, but I have a solid stash of information I can use to understand and re-implement the things I want to. Hexplore uses a \u003Ca href=\"https://en.wikipedia.org/wiki/Voxel\">voxel\u003C/a> engine, which (most probably, needs to be verified) was implemented in software. Considering the limitations of the software and hardware that existed back then, everything was new: 32-bit Windows, DirectX, hardware accelerators (nVidiaâ€™s Riva, 3dfxâ€™s Voodoo, and ATIâ€™s RAGE are some examples) were just becoming affordable for home computersâ€”you name it. \u003Cem>Could I re-implement this voxel engine in a modern API, say, Vulkan?\u003C/em>\u003C/p>\n\u003Cp>I honestly donâ€™t know. Thus, Iâ€™ve set the projectâ€™s milestones and will try to reach them:\u003C/p>\n\u003Cul class=\"contains-task-list\">\n\u003Cli class=\"task-list-item\">\u003Cinput type=\"checkbox\" checked disabled> Investigate the game and gather necessary resources for reverse engineering\u003C/li>\n\u003Cli class=\"task-list-item\">\u003Cinput type=\"checkbox\" disabled> Reverse engineer the gameâ€™s data file formats and produce documentation for them\u003C/li>\n\u003Cli class=\"task-list-item\">\u003Cinput type=\"checkbox\" disabled> Craft tools for viewing (and possibly manipulating) the gameâ€™s assets\u003C/li>\n\u003Cli class=\"task-list-item\">\u003Cinput type=\"checkbox\" disabled> Imagine something bigger.\u003C/li>\n\u003C/ul>\n\u003Cp>Understanding the gameâ€™s data file formats, although it sounds simple, will be both a difficult and time-consuming task â€” as such, it must not be underestimated. Iâ€™ve already started looking into the files that hold the gameâ€™s texts (i.e., the \u003Ccode>st1\u003C/code> files) and made some progress, but thatâ€™s a story for another post.\u003C/p>\n\u003Ch2 id=\"closing-words\">Closing words\u003C/h2>\n\u003Cp>The next time we meet, Iâ€™ll be making a deep dive into the gameâ€™s data file formats. Expect some frustration, as the developers have taken some clever measures against people like me (which is not unheard of). Weâ€™ll also get our hands dirty with some C++, talk about developer decisions, and continue our journey into the abyss. And as those who have played Hexplore vividly remember:\u003C/p>\n\u003Cblockquote>\n\u003Cp>You must gather your party before venturing forth.\u003C/p>\n\u003C/blockquote>\n\u003Csection data-footnotes=\"\" class=\"footnotes\">\u003Ch2 class=\"sr-only\" id=\"footnote-label\">Footnotes\u003C/h2>\n\u003Col>\n\u003Cli id=\"user-content-fn-1\">\n\u003Cp>Read(ing) the fucking manual. \u003Ca href=\"#user-content-fnref-1\" data-footnote-backref=\"\" aria-label=\"Back to reference 1\" class=\"data-footnote-backref\">â†©\u003C/a>\u003C/p>\n\u003C/li>\n\u003Cli id=\"user-content-fn-2\">\n\u003Cp>id Software began working on Doom \u003Ca href=\"https://5years.doomworld.com/interviews/johnromero/\">after the release of Spear of Destiny\u003C/a>, and the game was released on \u003Ca href=\"https://en.wikipedia.org/wiki/Doom_(1993_video_game)\">December 10, 1993\u003C/a>. \u003Ca href=\"#user-content-fnref-2\" data-footnote-backref=\"\" aria-label=\"Back to reference 2\" class=\"data-footnote-backref\">â†©\u003C/a>\u003C/p>\n\u003C/li>\n\u003C/ol>\n\u003C/section>",{"headings":120,"localImagePaths":146,"remoteImagePaths":147,"frontmatter":148,"imagePaths":152},[121,124,127,131,134,137,140,143],{"depth":52,"slug":122,"text":123},"first-things-first-baby-steps","First things first: Baby Steps",{"depth":52,"slug":125,"text":126},"the-lair-of-ghidra","The lair of Ghidra",{"depth":128,"slug":129,"text":130},3,"blessings","Blessings",{"depth":128,"slug":132,"text":133},"and-curses","â€¦and curses",{"depth":52,"slug":135,"text":136},"verifying-our-claims","Verifying our claims",{"depth":52,"slug":138,"text":139},"what-now","What now?",{"depth":52,"slug":141,"text":142},"closing-words","Closing words",{"depth":52,"slug":144,"text":145},"footnote-label","Footnotes",[114],[],{"title":82,"description":83,"pubDate":149,"heroImage":115,"category":87,"tags":150,"excerpt":97,"keywords":151},"2024-09-20",[87,88,89,90,91,92,93,94,95,96],[99,100,101,102,103,104,105,106,107,108,109,110],[114]]