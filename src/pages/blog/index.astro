---
import { Image } from 'astro:assets';
import { getCollection } from 'astro:content';
import BaseHead from '../../components/BaseHead.astro';
import SEOHead from '../../components/SEOHead.astro';
import Footer from '../../components/Footer.astro';
import FormattedDate from '../../components/FormattedDate.astro';
import Header from '../../components/Header.astro';
import { SITE_DESCRIPTION, SITE_TITLE, SITE_URL } from '../../consts';

// Filter out drafts in production, but show them in development
const allPosts = await getCollection('blog');
const isDev = import.meta.env.DEV;
const posts = allPosts
	.filter((post) => isDev || !post.data.draft)
	.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// Enhanced blog description for SEO
const blogDescription = `Explore ${SITE_TITLE} - A collection of articles about software development, DevOps, debugging, team dynamics, and the psychology behind great software. Read war stories and reflections from the trenches of technology.`;

// Keywords for SEO
const blogKeywords = [
	'blog',
	'software development',
	'DevOps',
	'programming',
	'debugging',
	'technology',
	'coding',
	'software engineering',
	'web development',
	'tech blog',
];

// Build ItemList schema for blog posts
const itemListSchema = {
	'@context': 'https://schema.org',
	'@type': 'ItemList',
	itemListElement: posts.map((post, index) => ({
		'@type': 'ListItem',
		position: index + 1,
		item: {
			'@type': 'BlogPosting',
			headline: post.data.title,
			description: post.data.description,
			url: new URL(`/blog/${post.id}/`, SITE_URL).toString(),
			datePublished: post.data.pubDate.toISOString(),
			dateModified: (post.data.updatedDate || post.data.pubDate).toISOString(),
			...(post.data.heroImage && {
				image: new URL(post.data.heroImage.src, SITE_URL).toString(),
			}),
		},
	})),
};
---

<!doctype html>
<html lang="en" class="dark">
	<head>
		<BaseHead title={`${SITE_TITLE} - Blog`} description={blogDescription} />
		<SEOHead
			title={`${SITE_TITLE} - Blog`}
			description={blogDescription}
			keywords={blogKeywords}
			canonical={new URL('/blog/', SITE_URL)}
			schema={{
				type: 'Blog',
				breadcrumbs: [
					{ name: 'Home', url: '/' },
					{ name: 'Blog', url: '/blog/' },
				],
			}}
		/>
		<script type="application/ld+json" set:html={JSON.stringify(itemListSchema)} is:inline />
	</head>
	<body class="min-h-screen bg-bg-01 text-white">
		<Header />
		
		<!-- Hero Section with Circuit Background -->
		<section class="bg-circuit relative py-16 md:py-24 px-4">
			<div class="max-w-7xl mx-auto text-center relative z-10">
				<h1 class="text-4xl md:text-6xl font-bold mb-4 text-white">
					Blog
				</h1>
				<p class="text-lg md:text-xl text-muted max-w-2xl mx-auto">
					War stories and reflections from the trenches of software development
				</p>
			</div>
		</section>

		<!-- Blog Posts Section -->
		<main class="max-w-7xl mx-auto px-4 py-12 md:py-16">
			{posts.length > 0 ? (
				<div class="masonry-grid">
					{
						posts.map((post) => (
							<article class="post-card group">
								<a 
									href={`/blog/${post.id}/`}
									class="block h-full"
									aria-label={`Read ${post.data.title}`}
								>
									{post.data.heroImage && (
										<div class="post-image-wrapper mb-4 overflow-hidden rounded-lg">
											<Image
												width={600}
												height={400}
												src={post.data.heroImage}
												alt={post.data.title}
												class="w-full h-auto object-cover transition-transform duration-300 group-hover:scale-105"
												loading="lazy"
											/>
										</div>
									)}
									<div class="post-content">
										{post.data.category && (
											<span class="inline-block px-3 py-1 mb-3 text-xs font-semibold rounded-full bg-accent/20 text-accent border border-accent/30">
												{post.data.category}
											</span>
										)}
										<h2 class="text-xl md:text-2xl font-bold mb-3 text-white group-hover:text-accent transition-colors duration-200 line-clamp-2">
											{post.data.title}
										</h2>
										{(post.data.description || post.data.excerpt) && (
											<p class="text-sm md:text-base text-slate-300 mb-4 line-clamp-3">
												{post.data.excerpt || post.data.description}
											</p>
										)}
										<div class="flex items-center justify-between text-sm text-muted">
											<time 
												datetime={post.data.pubDate.toISOString()}
												class="flex items-center gap-2"
											>
												<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
													<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
												</svg>
												<FormattedDate date={post.data.pubDate} />
											</time>
											{post.data.tags && post.data.tags.length > 0 && (
												<span class="text-xs text-muted">
													{post.data.tags.length} {post.data.tags.length === 1 ? 'tag' : 'tags'}
												</span>
											)}
										</div>
									</div>
								</a>
							</article>
						))
					}
				</div>
			) : (
				<div class="text-center py-16">
					<div class="card bg-card border border-slate-700 rounded-lg p-8 md:p-12 max-w-2xl mx-auto">
						<h2 class="text-2xl md:text-3xl font-bold mb-4 text-white">
							No posts yet
						</h2>
						<p class="text-slate-300">
							Check back soon for new content!
						</p>
					</div>
				</div>
			)}
		</main>

		<Footer />
	</body>
</html>

<style>
	/* Masonry Layout using CSS Columns */
	.masonry-grid {
		column-count: 1;
		column-gap: 1.5rem;
		column-fill: balance;
	}

	.post-card {
		break-inside: avoid;
		page-break-inside: avoid;
		margin-bottom: 1.5rem;
		@apply bg-card border border-slate-700 rounded-lg p-6 transition-all duration-300;
		display: inline-block;
		width: 100%;
	}

	.post-card:hover {
		@apply border-accent;
		box-shadow: 0 10px 25px -5px rgba(6, 182, 212, 0.1), 0 10px 10px -5px rgba(6, 182, 212, 0.04);
		transform: translateY(-2px);
	}

	.post-image-wrapper {
		aspect-ratio: 3 / 2;
		@apply bg-slate-800;
	}

	.post-image-wrapper img {
		width: 100%;
		height: 100%;
		object-fit: cover;
	}

	.post-content {
		display: flex;
		flex-direction: column;
		height: 100%;
	}

	/* Line clamp utilities */
	.line-clamp-2 {
		display: -webkit-box;
		-webkit-line-clamp: 2;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}

	.line-clamp-3 {
		display: -webkit-box;
		-webkit-line-clamp: 3;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}

	/* Responsive breakpoints */
	@media (min-width: 640px) {
		.masonry-grid {
			column-count: 2;
		}
	}

	@media (min-width: 1024px) {
		.masonry-grid {
			column-count: 3;
		}
	}

	/* Ensure cards don't break across columns on smaller screens */
	@media (max-width: 639px) {
		.post-card {
			margin-bottom: 1rem;
		}
	}
</style>
